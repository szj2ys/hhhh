import{l as ie,w as re}from"./@vue_runtime-dom@3.5.16-DflgTdyk.js";import{V as ne}from"./vuedraggable@4.1.0_vue@3.5.16_typescript@5.5.4_-DSN8-Pyo.js";import{c as ue,W as de,J as ce}from"./@element-plus_icons-vue@2.3.1_vue@3.5.16_typescript@5.5.4_-BbJVLfPu.js";import{m as pe,a as te,k as ae,l as K,u as me,n as fe}from"./index-DmF6C1yQ.js";import{p as X,U as he,g as Y,a as Z}from"./index-C2d1rLHN.js";import{o as ge,y as j,v as ve,D as ye,A as J}from"./lodash-es@4.17.21-5_SSvygx.js";import{E as M}from"./element-plus@2.10.2_vue@3.5.16_typescript@5.5.4_-o76SzKsV.js";import{u as le}from"./vue-i18n@11.1.5_vue@3.5.16_typescript@5.5.4_-ChhaddF7.js";import{d as oe,v as U,w as be,$ as G,c as x,o as c,a as H,K as V,H as L,F as we,l as g,I as v,D as W,M as ke,L as _e,n as Ue}from"./@vue_runtime-core@3.5.16-DNpmjUA2.js";import{u as xe,y}from"./@vue_reactivity@3.5.16-fU77kzLc.js";import{O as Q,p as ee}from"./@vue_shared@3.5.16-Dkxi7RdN.js";import{_ as Se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./dayjs@1.11.13-BIiDHjGT.js";import"./vue@3.5.16_typescript@5.5.4-D426WAv3.js";import"./sortablejs@1.14.0-Cc22K8CM.js";import"./@vueuse_core@12.8.2_typescript@5.5.4-DGup_1qK.js";import"./@vueuse_shared@12.8.2_typescript@5.5.4-BsA5SRX8.js";import"./store@2.0.12-BYMheg-V.js";import"./mitt@3.0.1-C1z4c41a.js";import"./pinia@2.3.1_typescript@5.5.4_vue@3.5.16_typescript@5.5.4_-CF7xEUeK.js";import"./vue-router@4.5.1_vue@3.5.16_typescript@5.5.4_-BpTAww-U.js";import"./axios@1.9.0-D--XfsWq.js";import"./nprogress@0.2.0-tbY8o1C4.js";import"./@vueuse_shared@9.13.0_vue@3.5.16_typescript@5.5.4_-CLudCabT.js";import"./@vueuse_core@9.13.0_vue@3.5.16_typescript@5.5.4_-B7bVexyo.js";import"./@sxzz_popperjs-es@2.11.7-D_chPuIy.js";import"./@ctrl_tinycolor@3.6.1-r5W6hzzQ.js";import"./async-validator@4.2.5-CDKkdPIV.js";import"./memoize-one@6.0.0-BdPwpGay.js";import"./normalize-wheel-es@1.2.0-BQoi3Ox2.js";import"./@floating-ui_dom@1.7.1-Ba-2EiSn.js";import"./@floating-ui_core@1.7.1-C83JrwzW.js";import"./@floating-ui_utils@0.2.9-CBkBHzV8.js";import"./@intlify_core-base@11.1.5-rFPZQXdu.js";import"./@intlify_shared@11.1.5-CY44FrR8.js";import"./@intlify_message-compiler@11.1.5-CZ-uatfp.js";function Be(){const{options:a}=pe.get("upload"),{user:P}=te(),{t:R}=le();async function l(d,D={}){return new Promise((I,A)=>{(async()=>{const{prefixPath:$,onProgress:u}=ge({},a,D),N=ae("");try{const{mode:p,type:S}=await K.base.comm.uploadMode(),f=p=="local",B=N+"_"+d.name;let m=f?B:X($,B);const o=async({host:r,preview:T,data:z})=>{const h=new FormData;h.append("key",m);for(const n in z)h.has(n)||h.append(n,z[n]);h.append("file",d);let b=0;const w={url:r,method:"POST",headers:{"Content-Type":"multipart/form-data",Authorization:f?P.token:null,language:null},timeout:6e5,data:h,onUploadProgress(n){b=n.total?Math.floor(n.loaded/n.total*100):0,u==null||u(b)},proxy:f};S=="minio"&&(w.headers["Content-Type"]=d.type,w.method="PUT",w.data=d),await K.request(w).then(n=>{b!=100&&(u==null||u(100)),m=encodeURIComponent(m);let k="";f?k=n:k=X(T||r,m),I({key:m,url:k,fileId:N})}).catch(n=>{M.error(n.message),A(n)})};f?o({host:"/admin/base/comm/upload"}):K.base.comm.upload(["aws","minio"].includes(S)?{key:m}:{}).then(r=>{switch(S){case"cos":o({host:r.url,data:r.credentials});break;case"oss":o({host:r.host,preview:r.publicDomain,data:{OSSAccessKeyId:r.OSSAccessKeyId,policy:r.policy,signature:r.signature}});break;case"qiniu":o({host:r.uploadUrl,preview:r.publicDomain,data:{token:r.token}});break;case"aws":o({host:r.url,data:r.fields});break;default:o({host:r.url,preview:r.previewUrl});break}}).catch(A)}catch(p){M.error(R("文件上传失败")),A(p)}})()})}return{options:a,toUpload:l}}const ze={key:0,class:"cl-upload__file-btn"},Ce={key:0,class:"cl-upload__footer"},Ve={key:0,class:"cl-upload__demo is-dragger"},De={key:1,class:"cl-upload__demo"},Ae={key:0,class:"text"},Ne={class:"cl-upload__item"},Te=oe({name:"undefined"}),Fe=oe({...Te,name:"cl-upload",props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,autoUpload:{type:Boolean,default:!0},size:[String,Number,Array],small:Boolean,icon:null,text:String,showTag:{type:Boolean,default:!0},showFileList:{type:Boolean,default:!0},draggable:Boolean,drag:Boolean,disabled:Boolean,deletable:Boolean,customClass:String,beforeUpload:Function,prefixPath:String},emits:["update:modelValue","change","upload","success","error","progress"],setup(a,{expose:P,emit:R}){ie(e=>({f5f20314:N.value[0],f5f202d6:N.value[1]}));const l=a,d=R,{refs:D,setRefs:I}=me(),{user:A}=te(),{options:q,toUpload:$}=Be(),{t:u}=le(),N=U(()=>{const e=l.size||q.size;return(j(e)?e:[e,e]).map(t=>ve(t)?t+"px":t)}),p=U(()=>l.isDisabled||l.disabled),S=l.limit||q.limit.upload,f=l.limitSize||q.limit.size,B=U(()=>{if(l.text!==void 0)return l.text;switch(l.type){case"file":return u("选择文件");case"image":return u("选择图片");default:return""}}),m=U(()=>({Authorization:A.token})),o=xe([]),r=U(()=>l.type=="file"?l.showFileList?!ye(o.value):!1:!0),T=U(()=>l.accept||(l.type=="file"?"":"image/*")),z=U(()=>{const e=o.value.length;return l.multiple&&!p.value?S-e>0:e==0});async function h(e,t){function s(){const i={uid:e.uid,size:e.size,name:e.name,type:Z(e.name),progress:l.autoUpload?0:100,url:"",preload:"",error:""};if(i.type=="image"&&e instanceof File&&(i.preload=window.webkitURL.createObjectURL(e)),d("upload",i,e),t)J(t,i);else if(l.multiple)if(z.value)o.value.push(i);else return M.warning(u("最多只能上传{n}个文件",{n:S})),!1;else o.value=[i];return!0}if(l.beforeUpload){let i=l.beforeUpload(e,t,{next:s});return fe(i)?i.then(s).catch(()=>null):i&&(i=s()),i}else return e.size/1024/1024>=f?(M.error(u("上传文件大小不能超过 {n}MB!",{n:f})),!1):s()}function b(e){o.value.splice(e,1),E()}function w(){o.value=[]}async function n(e,t){if(t||(t=o.value.find(s=>s.uid==e.file.uid)),!t)return!1;$(e.file,{prefixPath:l.prefixPath,onProgress(s){t.progress=s,d("progress",t)}}).then(s=>{J(t,s),d("success",t),E()}).catch(s=>{t.error=s.message,d("error",t)})}function k(){return o.value.find(e=>!e.url)}function E(){if(!k()){const e=Y(o.value),t=l.multiple?Y(o.value):e[0]||"";d("update:modelValue",t),d("change",t)}}function se(e){var t;w(),(t=D.upload)==null||t.clearFiles(),Ue(()=>{var s,i;(s=D.upload)==null||s.handleStart(e),(i=D.upload)==null||i.submit()})}return be(()=>l.modelValue,e=>{if(k())return!1;const t=(j(e)?e:[e]).filter(Boolean);o.value=t.map((s,i)=>{const _=o.value[i]||{};return J({progress:100,uid:ae()},_,{type:Z(s),url:s,preload:_.url==s?_.preload:s})}).filter((s,i)=>l.multiple?!0:i==0)},{immediate:!0}),P({isAdd:z,list:o,check:k,clear:w,remove:b,upload:se}),(e,t)=>{const s=G("el-button"),i=G("el-upload"),_=G("el-icon");return c(),x("div",{class:ee(["cl-upload__wrap",[a.customClass]])},[H("div",{class:ee(["cl-upload",[`cl-upload--${a.type}`,{"is-disabled":p.value,"is-multiple":a.multiple,"is-small":a.small}]])},[a.drag?V("",!0):(c(),x(we,{key:0},[a.type=="file"?(c(),x("div",ze,[g(i,{ref:y(I)("upload"),drag:a.drag,action:"",accept:T.value,"show-file-list":!1,"before-upload":h,"http-request":n,headers:m.value,multiple:a.multiple,disabled:p.value},{default:v(()=>[W(e.$slots,"default",{},()=>[g(s,{type:"success"},{default:v(()=>[ke(Q(B.value),1)]),_:1})],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):V("",!0)],64)),r.value?(c(),L(y(ne),{key:1,modelValue:o.value,"onUpdate:modelValue":t[0]||(t[0]=C=>o.value=C),class:"cl-upload__list",tag:"div","ghost-class":"Ghost","drag-class":"Drag","item-key":"uid",disabled:!a.draggable,onEnd:E},{footer:v(()=>[(a.type=="image"||a.drag)&&z.value?(c(),x("div",Ce,[g(i,{ref:y(I)("upload"),action:"",drag:a.drag,accept:T.value,"show-file-list":!1,"before-upload":h,"http-request":n,headers:m.value,multiple:a.multiple,disabled:p.value},{default:v(()=>[W(e.$slots,"default",{},()=>[a.drag?(c(),x("div",Ve,[g(_,{size:46},{default:v(()=>[g(y(de))]),_:1}),H("div",null,Q(y(u)("点击上传或将文件拖动到此处，文件大小限制{n}M",{n:y(f)})),1)])):(c(),x("div",De,[g(_,{size:36},{default:v(()=>[a.icon?(c(),L(_e(a.icon),{key:0})):(c(),L(y(ce),{key:1}))]),_:1}),B.value?(c(),x("span",Ae,Q(B.value),1)):V("",!0)]))],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):V("",!0)]),item:v(({element:C,index:O})=>[g(i,{action:"",accept:T.value,"show-file-list":!1,"http-request":F=>n(F,C),"before-upload":F=>{h(F,C)},headers:m.value,disabled:p.value},{default:v(()=>[W(e.$slots,"item",{item:C,index:O},()=>[H("div",Ne,[g(he,{"show-tag":a.showTag,item:C,list:o.value,disabled:p.value,deletable:a.deletable,onRemove:F=>b(O)},null,8,["show-tag","item","list","disabled","deletable","onRemove"]),a.small?(c(),L(_,{key:0,class:"cl-upload__item-remove",onClick:re(F=>b(O),["stop"])},{default:v(()=>[g(y(ue))]),_:2},1032,["onClick"])):V("",!0)])],!0)]),_:2},1032,["accept","http-request","before-upload","headers","disabled"])]),_:3},8,["modelValue","disabled"])):V("",!0)],2)],2)}}}),vt=Se(Fe,[["__scopeId","data-v-f04333c5"]]);export{vt as default};
