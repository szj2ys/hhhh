import{d as C}from"./dayjs@1.11.13-BIiDHjGT.js";import{a as D,u as $,g as L,s as w,l as U,t as se,k as N,r as oe}from"./index-DmF6C1yQ.js";import"./store@2.0.12-BYMheg-V.js";import{d as O}from"./pinia@2.3.1_typescript@5.5.4_vue@3.5.16_typescript@5.5.4_-CF7xEUeK.js";import{t as ae,F as ie,I as re,D as x,J as ce}from"./lodash-es@4.17.21-5_SSvygx.js";import{j as le,u as p,o as ue}from"./@vue_reactivity@3.5.16-fU77kzLc.js";import{n as V,w as W,v as K}from"./@vue_runtime-core@3.5.16-DNpmjUA2.js";import{l as fe}from"./socket.io-client@4.8.1-e_HRfn2I.js";import{E as de}from"./element-plus@2.10.2_vue@3.5.16_typescript@5.5.4_-o76SzKsV.js";const me=O("ai.socket",()=>{const{user:i}=D(),{mitt:e}=$(),s=le({});function a(c,l,o){if(!i.token)return!1;let t=c;l!=null&&l.key&&(t+=`.${l.key}`),s[t]&&d(t),s[t]||(s[t]=fe(L.host+"/"+c,{transports:["websocket","polling"],query:l,auth:{token:i.token}}),s[t].on("connect",()=>{}),s[t].on("disconnect",()=>{}),o==null||o.forEach(b=>{s[t].on(b,h=>{e.emit(t,h)})}))}function d(c){var l;(l=s[c])==null||l.disconnect(),s[c]=void 0}function m(c,l){var o;(o=s[c])==null||o.emit("send",l)}function n(c,l,o){var t;(t=s[c])==null||t.emit(l,o)}return{connect:a,disconnect:d,send:m,emit:n,client:s}});function he(i){const e=C(i);return e.isBefore(C().hour(0).minute(0).second(0))?e.format("YYYY-MM-DD HH:mm"):e.format("HH:mm")}const ve=O("ai.scroller",()=>{const{mitt:i}=$(),e=p(0),s=p(!0),a=ae((m,n=!0)=>{s.value=n,i.emit("chat.pageScroll",{top:m+Math.random(),smooth:n?"smooth":"auto"})},500);return{animation:s,top:e,scrollToBottom:m=>{a(999999+Math.random(),!1)},scrollTo:a}}),ge=!1,we=O("ai.voice",()=>{const i=me(),{mitt:e}=$(),s=[{label:"湾湾小何",value:"zh_female_wanwanxiaohe_moon_bigtts"},{label:"呆萌川妹",value:"zh_female_daimengchuanmei_moon_bigtts"},{label:"湾区大叔",value:"zh_female_wanqudashu_moon_bigtts"},{label:"高冷御姐",value:"zh_female_gaolengyujie_moon_bigtts"}],a=p(w.get("ai.voice.type")||s[0].value);function d(o){a.value=o,w.set("ai.voice.type",o),c(["hs-tts"])}const m=p(!!w.get("ai.voice.isPlay"));function n(o){w.set("ai.voice.isPlay",o)}function c(o){o.includes("hs-tts")&&i.connect("voice",{key:"hs-tts",params:JSON.stringify({voiceType:a.value,format:"mp3"})},["hs-tts"]),o.includes("hs-asr")&&i.connect("voice",{key:"hs-asr",params:JSON.stringify({format:"wav",rate:16e3})},["hs-asr"])}function l(){m.value&&(e.emit("voice.end",!0),e.emit("voice.stop")),i.disconnect("voice")}return{types:s,type:a,setType:d,isPlay:m,setPlay:n,connect:c,disconnect:l,permitted:ge}}),G=O("ai.chat",()=>{const i=J(),e=Q(),s=ve(),a=we(),{user:d}=D(),{route:m,mitt:n}=$(),c=p(!1),l=p(!1),o=p(!1),t=p("");function b(){t.value=""}async function h(u){var A;const _=u||t.value;if(!_||c.value)return;c.value=!0,l.value=!0,o.value=!0,e.append({content:_,role:"user"}),await V();const T=w.get("ai.role")||{title:"无角色",desc:"无描述"};let k=!1;const j={label:"zhidu",params:{content:_,objectId:((A=d.info)==null?void 0:A.id)+"-"+i.sessionId,role:T.title+":"+T.desc},onMessage({msgType:E,data:X}){const{isEnd:Z,content:B,isThinking:q,name:ee,type:F,nodeId:R,nodeType:te,status:H,result:I}=X,ne=ie(I==null?void 0:I.result)?JSON.stringify(I==null?void 0:I.result,null,4):String((I==null?void 0:I.result)||"null");E=="flow"&&H=="start"&&(k=!1);let y=e.list.find(f=>f.nodeId==R&&!f.isEnd&&f.role=="ai");if(!y){const f=()=>{e.append({nodeId:R,content:"",role:"ai",isVoice:a.isPlay,isShow:!1,isEnd:!1})};(H=="running"&&te=="llm"||F=="start"&&E=="tool")&&f(),E=="llmStream"&&f()}if(y){y.desc||(y.desc=[]),y._content||(y._content="");let f=re(y.desc);E=="tool"?((!f||(f==null?void 0:f.type)!=="tool")&&y.desc.push(f={}),f.type="tool",f.content=ee,f.loading=F=="start"):B!==void 0&&(q?((!f||(f==null?void 0:f.type)!="think")&&y.desc.push(f={content:""}),f.type="think",f.content+=B):y._content+=B),B&&(k=!0),y.content=y._content,(y.content||!x(f))&&(y.isShow=!0,c.value=!1),y.isEnd=Z}E=="flow"&&H=="end"&&(k||e.append({content:ne,role:"ai",isEnd:!0,isShow:!0})),s.scrollToBottom(!1),E=="flow"&&H=="end"&&v()}};return b(),s.scrollToBottom(),j}function v(){e.done(),l.value=!1,c.value=!1,o.value=!1}function r(){e.last&&(e.last.isStop=!0),v()}const g=p(!1),S=p();async function z(){S.value=m.query.roleId||"",i.refresh(),e.refresh(),a.connect(["hs-tts","hs-asr"]),Object.keys(localStorage).some(u=>u.startsWith("ai.message."))?localStorage.getItem(`ai.message.${i.sessionId}`)||Y(i.sessionId):U.user.info.getHistory().then(u=>{var _,T;u.sort((k,j)=>k.id-j.id);for(const k of u)w.set(k.sessionKey,k.desc);Y((T=(_=u[0])==null?void 0:_.desc[0])==null?void 0:T.id)}),await V(),s.scrollToBottom(),g.value=!0}function M(){a.disconnect()}function P(u){if(o.value){de.warning("生成中请等待，或者手动停止生成");return}u||(u=i.create()),Y(u.id),w.set("ai.role",u),oe.push({path:"/chat/detail",query:{sessionId:u.id,roleId:S.value}}),setTimeout(()=>{n.emit("chat.newChat",u)},50)}return n.on("user.logout",()=>{e.clear()}),{loading:c,running:l,execing:o,content:t,send:h,stop:r,clear:b,init:z,destroy:M,newChat:P,isLoaded:g,roleId:S,voicePermitted:a.permitted}}),Y=i=>{const e=`ai.message.${i}`;w.get(e)||U.user.info.getHistory({key:i}).then(s=>{if(s.list===void 0||s.data===null)return;s.list.sort((n,c)=>n.index-c.index);const a=[];for(const[n,c]of Object.entries(s.list)){const l=s.data.data[n],o={id:N(),content:l.content,role:l.role==="user"?"user":"ai",...se(c.status),isShow:!0};o.role==="ai"&&(o._content=o.content),a.push(o)}w.set(e,a);const d=J();G().newChat(d.info)})},J=O("ai.session",()=>{const i=G(),e=Q(),{route:s}=$(),a=p([]),d=p(),m=p();function n(){const r={id:N(),title:"新会话",createTime:C().format("YYYY-MM-DD HH:mm:ss"),roleId:i.roleId};return a.value.unshift(r),o(r),r}function c(r){return a.value.find(g=>g.id==r)}function l(r){d.value&&(d.value.title=r)}function o(r){r||(x(a.value)?r=n():r=a.value[0]),d.value=r,m.value=r.id}function t(r){o(a.value.find(g=>g.id==r))}function b(r){var g;a.value=a.value.filter(S=>S.id!==r),w.remove(`ai.session.${r}`),e.clear(r),((g=d.value)==null?void 0:g.id)==r&&i.newChat(a.value[0])}function h(){d.value=void 0,a.value=[]}function v(){m.value=s.query.sessionId,a.value=w.get(`ai.session.${i.roleId}`)||[],x(a.value)?o(n()):m.value?t(m.value):o(a.value[0])}return W(a,r=>{x(r)||w.set(`ai.session.${i.roleId}`,r)},{deep:!0}),{list:a,info:d,sessionId:m,create:n,find:c,set:o,setById:t,setTitle:l,clear:h,remove:b,refresh:v}}),Q=O("ai.message",()=>{const i=J(),e=p([]),s=ue({page:1,size:20,total:0}),a=K(()=>{var h;let t=(h=e.value[0])==null?void 0:h.createTime,b=0;return e.value.map((v,r)=>{if(v[0]&&t){const g=he(v.createTime);r==0&&(v.date=g),C(v.createTime).subtract(10,"minute").isAfter(C(t))&&(v.date=g,t=v.createTime)}return v}).filter((v,r,g)=>v.isNew?(b++,!0):r>=g.length-s.page*s.size-b)});function d(t){t.role||(t.role="user",t.isAnimation=!0),t.isNew=!0,t.id||(t.id=N()),x(e.value)&&i.setTitle(t.content),e.value.push(t)}function m(){e.value.forEach(t=>{t.isEnd=!0})}function n(t){t?w.remove(`ai.message.${t}`):(e.value=[],w.remove(`ai.message.${i.sessionId}`))}const c=K(()=>ce(e.value,t=>t.role=="ai"));function l(){e.value=w.get(`ai.message.${i.sessionId}`)||[],s.total=e.value.length}function o(){s.page*s.size>=s.total||(s.page+=1)}return W(e,t=>{x(t)||w.set(`ai.message.${i.sessionId}`,t.map(b=>({...b,isVoice:!1,isNew:!1,isEnd:!0})))},{deep:!0}),{pagination:s,data:e,list:a,last:c,append:d,clear:n,done:m,refresh:l,nextPage:o}});function xe(){const{user:i}=D();let e=null;async function s(d,m,n){const c=!!(n!=null&&n.isStream);let l="";return e=new AbortController,new Promise((o,t)=>{const b=n!=null&&n.isDebug?"/open/flow/run/debug":"/open/flow/run/invoke";fetch(L.baseUrl+b,{method:"POST",headers:{Authorization:i.token,"Content-Type":"application/json"},body:JSON.stringify({params:m,label:d,stream:c,nodeId:n==null?void 0:n.nodeId,returnNode:(n==null?void 0:n.returnNode)==null?!0:n==null?void 0:n.returnNode}),signal:e==null?void 0:e.signal}).then(h=>{if(h.body)if(c){const v=h.body.getReader(),r=new TextDecoder("utf-8"),g=new ReadableStream({start(S){function z(){v.read().then(({done:M,value:P})=>{if(M){S.close();return}let u=r.decode(P,{stream:!0});if(n!=null&&n.streamCb){l&&(u=l+u),u.indexOf("data:")==0&&(u=`

`+u);try{u.split(/\n\ndata:/g).filter(Boolean).map(T=>JSON.parse(T)).forEach(n==null?void 0:n.streamCb),l=""}catch{l=u}}S.enqueue(u),z()})}z()}});return new Response(g)}else return h.json()}).then(h=>{if(c)return h;h.code==1e3?o(h.data.result):t(h)}).catch(t)})}function a(){e&&(e.abort(),e=null)}return{invokeFlow:s,cancelFlow:a}}export{G as a,Q as b,me as c,xe as d,we as e,ve as f,Y as g,J as u};
