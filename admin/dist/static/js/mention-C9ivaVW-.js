var oe=Object.defineProperty;var re=(l,c,f)=>c in l?oe(l,c,{enumerable:!0,configurable:!0,writable:!0,value:f}):l[c]=f;var k=(l,c,f)=>re(l,typeof c!="symbol"?c+"":c,f);import{w as ne}from"./@vue_runtime-dom@3.5.16-DriBzn4z.js";import{Q as b}from"./quill@2.0.3-DTfVaYMe.js";import{u as se}from"./index-BDeQYItE.js";import"./store@2.0.12-i6xqVJod.js";import{d as R,e as ie,A as W,x as ae}from"./lodash-es@4.17.21-BYk7DlcU.js";import{D as z}from"./quill-delta@5.1.0-uiY-OXVA.js";import{d as Y,v as I,e as pe,f as le,P as w,c as v,o as d,a as E,i as C,H as S,x as K,z as G,F as O,L as Q,y as ce,J as j,w as me,n as de}from"./@vue_runtime-core@3.5.16-Cn8z-kNe.js";import{u as ue}from"./vue-i18n@11.1.5_vue@3.5.16_typescript@5.5.4_-Bqjl69Su.js";import{v as fe,u as be,y as u}from"./@vue_reactivity@3.5.16-Dqy0TPbS.js";import{q as J,O as T,p as X}from"./@vue_shared@3.5.16-UwmvJIHj.js";import"./parchment@3.0.0-DI0xVRB_.js";import"./eventemitter3@5.0.1-ET5Ll1Sg.js";import"./chardet@2.1.0-CTPPlwpv.js";import"./@vueuse_core@12.8.2_typescript@5.5.4-7kYVjNRB.js";import"./@vueuse_shared@12.8.2_typescript@5.5.4-CuUdMqkw.js";import"./mitt@3.0.1-C1z4c41a.js";import"./@codemirror_language-data@6.5.1-Blx1hvTn.js";import"./@codemirror_language@6.11.1-BYrSuhr8.js";import"./@lezer_common@1.2.3-CP7NCNqd.js";import"./@codemirror_state@6.5.2-DQ6R6BiX.js";import"./@marijn_find-cluster-break@1.0.2-DXwl3gUT.js";import"./@codemirror_view@6.37.1-Bd3_Yh4F.js";import"./style-mod@4.1.2-Bc2inJdb.js";import"./w3c-keyname@2.2.8-Vcq4gwWv.js";import"./@lezer_highlight@1.2.1-DwVMghhY.js";import"./pinia@2.3.1_typescript@5.5.4_vue@3.5.16_typescript@5.5.4_-BZ2tmr1d.js";import"./vue-router@4.5.1_vue@3.5.16_typescript@5.5.4_-ODt3CAxp.js";import"./element-plus@2.9.11_vue@3.5.16_typescript@5.5.4_-BTKo5Rtv.js";import"./@vueuse_shared@9.13.0_vue@3.5.16_typescript@5.5.4_-4q0MSQPl.js";import"./@vueuse_core@9.13.0_vue@3.5.16_typescript@5.5.4_-DmiypGF2.js";import"./@element-plus_icons-vue@2.3.1_vue@3.5.16_typescript@5.5.4_-CeLFb4Nw.js";import"./@sxzz_popperjs-es@2.11.7-D_chPuIy.js";import"./@ctrl_tinycolor@3.6.1-r5W6hzzQ.js";import"./dayjs@1.11.13-DUxgsv0d.js";import"./async-validator@4.2.5-CDKkdPIV.js";import"./memoize-one@6.0.0-BdPwpGay.js";import"./normalize-wheel-es@1.2.0-BQoi3Ox2.js";import"./@floating-ui_dom@1.7.1-Ba-2EiSn.js";import"./@floating-ui_core@1.7.1-C83JrwzW.js";import"./@floating-ui_utils@0.2.9-CBkBHzV8.js";import"./comm-Ba3vmJ1R.js";import"./vue-echarts@7.0.3_@vue_runtime-core@3.5.16_echarts@5.6.0_vue@3.5.16_typescript@5.5.4_-Dhz4IGE5.js";import"./echarts@5.6.0-DvAKqd2B.js";import"./tslib@2.3.0-BDyQ-Jie.js";import"./zrender@5.6.1-DcQm8NwP.js";import"./axios@1.9.0-D--XfsWq.js";import"./nprogress@0.2.0-dOd6e7EG.js";import"./@intlify_core-base@11.1.5-rFPZQXdu.js";import"./@intlify_shared@11.1.5-CY44FrR8.js";import"./@intlify_message-compiler@11.1.5-CZ-uatfp.js";import"./fast-diff@1.3.0-Az_-rVRq.js";import"./lodash.clonedeep@4.5.0-CLkF5oof.js";import"./lodash.isequal@4.5.0-DsCeOh10.js";const ve={class:"p-2 pb-0"},ye=["onMousedown"],ge={key:0,class:"ai-mention__popper-empty"},xe=Y({name:"undefined"}),_t=Y({...xe,name:"ai-mention",props:{modelValue:String,height:{type:String,default:"80px"},options:{type:Array,default:()=>[]},placeholder:String,prefix:{type:String,default:"@"},valueFormatter:Function,labelFormatter:Function,popperClass:String,border:{type:Boolean,default:!0},autoFocus:{type:Boolean,default:!1},isGroup:{type:Boolean,default:!1}},emits:["update:modelValue","change"],setup(l,{expose:c,emit:f}){const i=l,N=f,{refs:D,setRefs:x}=se(),{t:F}=ue(),$=fe();let B=0,t;const Z=b.import("blots/embed");class h extends Z{static create(o){const r=super.create();return r.setAttribute("data-label",o.label),r.setAttribute("data-value",o.value),r.contentEditable="false",r.innerHTML=o.label,r}static value(o){return{label:o.getAttribute("data-label"),value:o.getAttribute("data-value")}}}k(h,"blotName","mention"),k(h,"tagName","span"),k(h,"className","ai-mention__label"),b.imports["formats/mention"]||b.register(h);function V(e={}){const{ops:o=[]}=(t==null?void 0:t.getContents())||{};return o.map(r=>{var s;if(ae(r.insert))return r.insert;if((s=r.insert)!=null&&s.mention){const{label:a,value:g}=r.insert.mention;return e.isValue?i.valueFormatter?i.valueFormatter(r.insert.mention):`{${g}}`:e.custom?e.custom(r.insert.mention):a}return""}).join("")}function L(){return V({isValue:!0})}function q(){t=new b(D.editor,{placeholder:i.placeholder||F("请输入"),modules:{keyboard:{bindings:{list:{key:"Enter",handler(){return n.visible?(n.onKeyDown({key:"Enter"}),!1):!0}}}}}}),t.clipboard.addMatcher(Node.ELEMENT_NODE,function(e,o){const r=new z;return o.ops.forEach(s=>{r.insert(s.insert)}),r}),t.root.addEventListener("keydown",e=>{if(e.key==="Escape"&&(n.close(),e.preventDefault()),e.key=="Backspace"){const o=t==null?void 0:t.getSelection();o&&o.index>0&&(t==null?void 0:t.getText(o.index-1,1))===""&&(t==null||t.deleteText(o.index-1,1));return}["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key)&&n.visible&&(n.onKeyDown(e),e.preventDefault())}),t.on("text-change",R(()=>{var r;const e=(r=t==null?void 0:t.getSelection())==null?void 0:r.index;if(e===void 0)return;V({custom:()=>" "})[e-1]==i.prefix?(B=e,n.open()):n.close(),P()}),300),me(()=>i.modelValue,e=>{L()!=e&&($.value=e,ee(e))},{immediate:!0}),i.autoFocus&&setTimeout(()=>{M()},10)}function ee(e=""){const o=new z;if(e){const r=/\{([^}]+)\}/g;let s=0,a;for(;(a=r.exec(e))!==null;){a.index>s&&o.insert(e.substring(s,a.index));const g=a[1],p=y.value.find(m=>(m==null?void 0:m.value)===g);if(p){const m={...p};i.labelFormatter?m.label=i.labelFormatter(p):m.label=`${i.prefix}${p.label}`,o.insert({mention:m})}else o.insert(a[0]);s=a.index+a[0].length}s<e.length&&o.insert(e.substring(s))}t==null||t.setContents(o)}function P(){const e=L();$.value=e,N("update:modelValue",e),N("change",e)}function H(){t=null}function M(){setTimeout(()=>{t==null||t.focus(),t==null||t.setSelection(((t==null?void 0:t.getLength())||0)-1,0)},10)}function A(e){var a;let r=(((a=t==null?void 0:t.getSelection())==null?void 0:a.index)||0)-1;r<0&&(r=B),t==null||t.deleteText(r,1);const s={...e};i.labelFormatter?s.label=i.labelFormatter(e):s.label=`${i.prefix}${e.label}`,t==null||t.insertEmbed(r,"mention",s,b.sources.USER),t==null||t.insertText(r+1,"​",b.sources.USER),t==null||t.setSelection(r+2,0),n.close(),P()}const n=be({visible:!1,pos:{top:0,left:0},keyWord:"",open:R(()=>{var e;n.visible=!0,n.focusKey=((e=y.value[0])==null?void 0:e.value)||"",n.updatePos(),de(()=>{D.picker.click()})},100),close(){var e;(e=D.popover)==null||e.hide()},onHide(){n.visible=!1},updatePos(){const e=t==null?void 0:t.getSelection();if(e){const o=t==null?void 0:t.getBounds(e.index);n.pos={top:((o==null?void 0:o.top)||0)+20,left:(o==null?void 0:o.left)||0}}},focusKey:"",onKeyDown(e){if(!n.visible)return;let o=0;const r=y.value.findIndex(a=>n.focusKey==a.value);switch(e.key){case"ArrowUp":o=r-1;break;case"ArrowDown":o=r+1;break;case"Enter":A(y.value[r]);break}const s=y.value[o];s&&(n.focusKey=s.value)}}),U=I(()=>{let e=[];return i.isGroup?e=i.options:e=[{children:i.options}],ie(e).filter(o=>(o.children=(o.children||[]).filter(r=>{var s;return n.keyWord?(s=r.label)==null?void 0:s.includes(n.keyWord):!0}),!W(o.children)))}),y=I(()=>i.options.map(e=>e.children||[]).flat());return pe(()=>{q()}),le(()=>{H()}),c({getText:V,select:A,focus:M,destroy:H}),(e,o)=>{const r=w("el-input"),s=w("el-text"),a=w("el-scrollbar"),g=w("el-popover");return d(),v("div",{class:X(["ai-mention",{"is-border":l.border}])},[E("div",{class:"ai-mention__editor",ref:u(x)("editor"),style:J({height:l.height})},null,4),C(g,{ref:u(x)("popover"),trigger:"click",placement:"bottom-start","popper-class":["ai-mention__popper",l.popperClass||""],"popper-style":{padding:"0",borderRadius:"6px"},width:200,offset:5,"hide-after":0,onHide:n.onHide},{reference:S(()=>[E("div",{class:"ai-mention__popper-picker",style:J({top:n.pos.top+"px",left:n.pos.left+"px"}),ref:u(x)("picker")},null,4)]),default:S(()=>[E("div",ve,[C(r,{modelValue:n.keyWord,"onUpdate:modelValue":o[0]||(o[0]=p=>n.keyWord=p),placeholder:u(F)("搜索"),clearable:""},null,8,["modelValue","placeholder"])]),C(a,{"max-height":"200px"},{default:S(()=>[E("div",{class:"ai-mention__popper-list",ref:u(x)("list"),tabindex:0,onKeydown:o[1]||(o[1]=(...p)=>n.onKeyDown&&n.onKeyDown(...p))},[K(e.$slots,"popper-prefix"),(d(!0),v(O,null,Q(U.value,(p,m)=>(d(),v("div",{class:"ai-mention__popper-group",key:m},[p.label?(d(),ce(s,{key:0,tag:"p",class:"p-[5px] text-[10px]"},{default:S(()=>[j(T(p.label),1)]),_:2},1024)):G("",!0),(d(!0),v(O,null,Q(p.children,(_,te)=>(d(),v("div",{key:te,class:X(["ai-mention__popper-item",{"is-focus":n.focusKey==_.value}]),onMousedown:ne(he=>A(_),["stop","prevent"])},[K(e.$slots,"popper-item",{item:_},()=>[j(T(_.label),1)])],42,ye))),128))]))),128)),K(e.$slots,"popper-suffix"),u(W)(U.value)?(d(),v("div",ge,T(u(F)("暂无数据")),1)):G("",!0)],544)]),_:3})]),_:3},8,["popper-class","onHide"])],2)}}});export{_t as default};
