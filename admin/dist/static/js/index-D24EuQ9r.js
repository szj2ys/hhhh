import{m as A,a as C,o as M,k as h,w as O,t as K}from"./index-C5WS2hJt.js";import{p as b}from"./index-D9jMTor-.js";import{o as P}from"./lodash-es@4.17.21-BYk7DlcU.js";import{a as x}from"./element-plus@2.9.11_vue@3.5.16_typescript@5.5.4_-BTKo5Rtv.js";import{u as z}from"./vue-i18n@11.1.5_vue@3.5.16_typescript@5.5.4_-Bqjl69Su.js";function _(){const{options:f}=A.get("upload"),{user:g}=C(),{t:U}=z();async function v(s,I={}){return new Promise((S,r)=>{(async()=>{const{prefixPath:D,onProgress:e}=P({},f,I),y=M("");try{const{mode:p,type:m}=await h.base.comm.uploadMode(),i=p=="local",T=O(s.name),w=K(s.name)+"_"+y+"."+T;let o=i?w:b(D,w);const n=async({host:a,preview:q,data:k})=>{const c=new FormData;c.append("key",o);for(const t in k)c.has(t)||c.append(t,k[t]);c.append("file",s);let u=0;const l={url:a,method:"POST",headers:{"Content-Type":"multipart/form-data",Authorization:i?g.token:null,language:null},timeout:6e5,data:c,onUploadProgress(t){u=t.total?Math.floor(t.loaded/t.total*100):0,e==null||e(u)},proxy:i};m=="minio"&&(l.headers["Content-Type"]=s.type,l.method="PUT",l.data=s),await h.request(l).then(t=>{u!=100&&(e==null||e(100)),o=encodeURIComponent(o);let d="";i?d=t:d=b(q||a,o),S({key:o,url:d,fileId:y})}).catch(t=>{x.error(t.message),r(t)})};i?n({host:"admin/base/comm/upload"}):h.base.comm.upload(["aws","minio"].includes(m)?{key:o}:{}).then(a=>{switch(m){case"cos":n({host:a.url,data:a.credentials});break;case"oss":n({host:a.host,preview:a.publicDomain,data:{OSSAccessKeyId:a.OSSAccessKeyId,policy:a.policy,signature:a.signature}});break;case"qiniu":n({host:a.uploadUrl,preview:a.publicDomain,data:{token:a.token}});break;case"aws":n({host:a.url,data:a.fields});break;default:n({host:a.url,preview:a.previewUrl});break}}).catch(r)}catch(p){x.error(U("文件上传失败")),r(p)}})()})}return{options:f,toUpload:v}}export{_ as u};
