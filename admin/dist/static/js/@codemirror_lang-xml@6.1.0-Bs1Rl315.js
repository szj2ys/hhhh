import{p as I}from"./@lezer_xml@1.0.6-DHukboQv.js";import{L as F,s as $,c as L,d as _,f as w,l as x}from"./@codemirror_language@6.11.1-BYrSuhr8.js";import{E as M}from"./@codemirror_state@6.5.2-DQ6R6BiX.js";import{E as k}from"./@codemirror_view@6.37.1-Bd3_Yh4F.js";import"./@lezer_lr@1.4.2-Ci39YVr6.js";import"./@lezer_common@1.2.3-CP7NCNqd.js";import"./@lezer_highlight@1.2.1-DwVMghhY.js";import"./style-mod@4.1.2-Bc2inJdb.js";import"./@marijn_find-cluster-break@1.0.2-DXwl3gUT.js";import"./w3c-keyname@2.2.8-Vcq4gwWv.js";function v(e,t){let i=t&&t.getChild("TagName");return i?e.sliceString(i.from,i.to):""}function O(e,t){let i=t&&t.firstChild;return!i||i.name!="OpenTag"?"":v(e,i)}function D(e,t,i){let n=t&&t.getChildren("Attribute").find(o=>o.from<=i&&o.to>=i),a=n&&n.getChild("AttributeName");return a?e.sliceString(a.from,a.to):""}function N(e){for(let t=e&&e.parent;t;t=t.parent)if(t.name=="Element")return t;return null}function P(e,t){var i;let n=$(e).resolveInner(t,-1),a=null;for(let o=n;!a&&o.parent;o=o.parent)(o.name=="OpenTag"||o.name=="CloseTag"||o.name=="SelfClosingTag"||o.name=="MismatchedCloseTag")&&(a=o);if(a&&(a.to>t||a.lastChild.type.isError)){let o=a.parent;if(n.name=="TagName")return a.name=="CloseTag"||a.name=="MismatchedCloseTag"?{type:"closeTag",from:n.from,context:o}:{type:"openTag",from:n.from,context:N(o)};if(n.name=="AttributeName")return{type:"attrName",from:n.from,context:a};if(n.name=="AttributeValue")return{type:"attrValue",from:n.from,context:a};let s=n==a||n.name=="Attribute"?n.childBefore(t):n;return(s==null?void 0:s.name)=="StartTag"?{type:"openTag",from:t,context:N(o)}:(s==null?void 0:s.name)=="StartCloseTag"&&s.to<=t?{type:"closeTag",from:t,context:o}:(s==null?void 0:s.name)=="Is"?{type:"attrValue",from:t,context:a}:s?{type:"attrName",from:t,context:a}:null}else if(n.name=="StartCloseTag")return{type:"closeTag",from:t,context:n.parent};for(;n.parent&&n.to==t&&!(!((i=n.lastChild)===null||i===void 0)&&i.type.isError);)n=n.parent;return n.name=="Element"||n.name=="Text"||n.name=="Document"?{type:"tag",from:t,context:n.name=="Element"?n:N(n)}:null}class B{constructor(t,i,n){this.attrs=i,this.attrValues=n,this.children=[],this.name=t.name,this.completion=Object.assign(Object.assign({type:"type"},t.completion||{}),{label:this.name}),this.openCompletion=Object.assign(Object.assign({},this.completion),{label:"<"+this.name}),this.closeCompletion=Object.assign(Object.assign({},this.completion),{label:"</"+this.name+">",boost:2}),this.closeNameCompletion=Object.assign(Object.assign({},this.completion),{label:this.name+">"}),this.text=t.textContent?t.textContent.map(a=>({label:a,type:"text"})):[]}}const E=/^[:\-\.\w\u00b7-\uffff]*$/;function j(e){return Object.assign(Object.assign({type:"property"},e.completion||{}),{label:e.name})}function A(e){return typeof e=="string"?{label:`"${e}"`,type:"constant"}:/^"/.test(e.label)?e:Object.assign(Object.assign({},e),{label:`"${e.label}"`})}function H(e,t){let i=[],n=[],a=Object.create(null);for(let l of t){let p=j(l);i.push(p),l.global&&n.push(p),l.values&&(a[l.name]=l.values.map(A))}let o=[],s=[],h=Object.create(null);for(let l of e){let p=n,u=a;l.attributes&&(p=p.concat(l.attributes.map(r=>typeof r=="string"?i.find(b=>b.label==r)||{label:r,type:"property"}:(r.values&&(u==a&&(u=Object.create(u)),u[r.name]=r.values.map(A)),j(r)))));let g=new B(l,p,u);h[g.name]=g,o.push(g),l.top&&s.push(g)}s.length||(s=o);for(let l=0;l<o.length;l++){let p=e[l],u=o[l];if(p.children)for(let g of p.children)h[g]&&u.children.push(h[g]);else u.children=o}return l=>{var p;let{doc:u}=l.state,g=P(l.state,l.pos);if(!g||g.type=="tag"&&!l.explicit)return null;let{type:r,from:b,context:c}=g;if(r=="openTag"){let m=s,f=O(u,c);if(f){let d=h[f];m=(d==null?void 0:d.children)||o}return{from:b,options:m.map(d=>d.completion),validFor:E}}else if(r=="closeTag"){let m=O(u,c);return m?{from:b,to:l.pos+(u.sliceString(l.pos,l.pos+1)==">"?1:0),options:[((p=h[m])===null||p===void 0?void 0:p.closeNameCompletion)||{label:m+">",type:"type"}],validFor:E}:null}else if(r=="attrName"){let m=h[v(u,c)];return{from:b,options:(m==null?void 0:m.attrs)||n,validFor:E}}else if(r=="attrValue"){let m=D(u,c,b);if(!m)return null;let f=h[v(u,c)],d=((f==null?void 0:f.attrValues)||a)[m];return!d||!d.length?null:{from:b,to:l.pos+(u.sliceString(l.pos,l.pos+1)=='"'?1:0),options:d,validFor:/^"[^"]*"?$/}}else if(r=="tag"){let m=O(u,c),f=h[m],d=[],C=c&&c.lastChild;m&&(!C||C.name!="CloseTag"||v(u,C)!=m)&&d.push(f?f.closeCompletion:{label:"</"+m+">",type:"type",boost:2});let y=d.concat(((f==null?void 0:f.children)||(c?o:s)).map(T=>T.openCompletion));if(c&&(f!=null&&f.text.length)){let T=c.firstChild;T.to>l.pos-20&&!/\S/.test(l.state.sliceDoc(T.to,l.pos))&&(y=y.concat(f.text))}return{from:b,options:y,validFor:/^<\/?[:\-\.\w\u00b7-\uffff]*$/}}else return null}}const S=F.define({name:"xml",parser:I.configure({props:[_.add({Element(e){let t=/^\s*<\//.test(e.textAfter);return e.lineIndent(e.node.from)+(t?0:e.unit)},"OpenTag CloseTag SelfClosingTag"(e){return e.column(e.node.from)+e.unit}}),w.add({Element(e){let t=e.firstChild,i=e.lastChild;return!t||t.name!="OpenTag"?null:{from:t.to,to:i.name=="CloseTag"?i.from:e.to}}}),x.add({"OpenTag CloseTag":e=>e.getChild("TagName")})]}),languageData:{commentTokens:{block:{open:"<!--",close:"-->"}},indentOnInput:/^\s*<\/$/}});function Z(e={}){let t=[S.data.of({autocomplete:H(e.elements||[],e.attributes||[])})];return e.autoCloseTags!==!1&&t.push(R),new L(S,t)}function V(e,t,i=e.length){if(!t)return"";let n=t.firstChild,a=n&&n.getChild("TagName");return a?e.sliceString(a.from,Math.min(a.to,i)):""}const R=k.inputHandler.of((e,t,i,n,a)=>{if(e.composing||e.state.readOnly||t!=i||n!=">"&&n!="/"||!S.isActiveAt(e.state,t,-1))return!1;let o=a(),{state:s}=o,h=s.changeByRange(l=>{var p,u,g;let{head:r}=l,b=s.doc.sliceString(r-1,r)==n,c=$(s).resolveInner(r,-1),m;if(b&&n==">"&&c.name=="EndTag"){let f=c.parent;if(((u=(p=f.parent)===null||p===void 0?void 0:p.lastChild)===null||u===void 0?void 0:u.name)!="CloseTag"&&(m=V(s.doc,f.parent,r))){let d=r+(s.doc.sliceString(r,r+1)===">"?1:0),C=`</${m}>`;return{range:l,changes:{from:r,to:d,insert:C}}}}else if(b&&n=="/"&&c.name=="StartCloseTag"){let f=c.parent;if(c.from==r-2&&((g=f.lastChild)===null||g===void 0?void 0:g.name)!="CloseTag"&&(m=V(s.doc,f,r))){let d=r+(s.doc.sliceString(r,r+1)===">"?1:0),C=`${m}>`;return{range:M.cursor(r+C.length,-1),changes:{from:r,to:d,insert:C}}}}return{range:l}});return h.changes.empty?!1:(e.dispatch([o,s.update(h,{userEvent:"input.complete",scrollIntoView:!0})]),!0)});export{R as autoCloseTags,H as completeFromSchema,Z as xml,S as xmlLanguage};
